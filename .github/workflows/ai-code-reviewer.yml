name: AI Code Reviewer

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    if: github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    steps:
      - name: Generate AI review
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-4o-mini' }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            if (!process.env.OPENAI_API_KEY) {
              core.setFailed('Missing OPENAI_API_KEY secret.');
              return;
            }

            const diffResponse = await github.rest.pulls.get({
              owner,
              repo,
              pull_number,
              mediaType: { format: 'diff' },
            });

            let diff = diffResponse.data || '';
            const maxChars = 20000;
            let truncated = false;
            if (diff.length > maxChars) {
              diff = diff.slice(0, maxChars);
              truncated = true;
            }

            const prompt = [
              'You are an AI code reviewer. Provide a concise review of the PR diff.',
              'Focus on: correctness, potential bugs, security, performance, and tests.',
              'If there are no issues, say "No issues found".',
              truncated ? 'Note: diff was truncated.' : '',
              '',
              'PR Diff:',
              diff,
            ].filter(Boolean).join('\n');

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
              },
              body: JSON.stringify({
                model: process.env.OPENAI_MODEL || 'gpt-4o-mini',
                messages: [
                  { role: 'system', content: 'You are a careful, concise code reviewer.' },
                  { role: 'user', content: prompt },
                ],
                temperature: 0.2,
                max_tokens: 600,
              }),
            });

            if (!response.ok) {
              const errorText = await response.text();
              core.setFailed(`OpenAI request failed: ${response.status} ${errorText}`);
              return;
            }

            const data = await response.json();
            const content = data.choices?.[0]?.message?.content?.trim();
            const body = content || 'No issues found.';

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pull_number,
              body: `### AI Code Review\n\n${body}`,
            });
